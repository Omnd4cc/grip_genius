# Beta 智能分析系统 - 技术架构设计

## 1. 系统概述

本系统是一个基于**计算机视觉**和**机器学习**的攀岩动作分析工具。核心设计理念是：

> **让 AI 做感知，让规则做推理**

- AI 负责：检测岩点位置、识别人体姿态
- 规则负责：确定线路、判断 Top/Start、追踪动作

---

## 2. 核心设计原则

### 2.1 领域知识的处理方式

| 领域知识 | 处理方式 | 原因 |
|---------|---------|------|
| "这是一个岩点" | AI 学习 (YOLO) | 视觉模式识别，AI 擅长 |
| "同色岩点属于同一条线路" | 规则 (颜色聚类) | 这是定义，不是模式 |
| "最高的点是 Top" | 规则 (Y坐标比较) | 简单数学，100%准确 |
| "人碰的点确定当前线路" | 规则 (距离判断) | 需要跨模型关联 |

### 2.2 为什么不让 AI 学习所有规则？

- ❌ 需要大量标注 "这是 Top"、"这是灰色线路"
- ❌ 泛化差：换个岩馆颜色不同就失效
- ❌ 黑盒：出错了不知道为什么
- ✅ 用规则：零标注、可解释、可调试

---

## 3. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Phase 1: 预处理 (只执行一次)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入: 攀岩视频                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 1: 关键帧抽取                                                  │   │
│   │  - 抽取 5 帧 (开头/1/4/中间/3/4/结尾)                                 │   │
│   │  - 目的: 人遮挡不同区域，提高岩点检测覆盖率                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 2: YOLO 岩点检测                                               │   │
│   │  - 对每帧运行 YOLO 模型                                              │   │
│   │  - 模型只学习一件事: "这是岩点"                                       │   │
│   │  - 输出: [{x, y, width, height, confidence}, ...]                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 3: 多帧融合对齐                                                │   │
│   │  - 同一视角，多帧结果 NMS 去重                                        │   │
│   │  - 提高准确性，减少漏检                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 4: 颜色提取 (传统 CV)                                          │   │
│   │  - 对每个检测框提取主色调 (HSV)                                       │   │
│   │  - 忽略阴影/高光像素                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 5: 颜色聚类 → 线路分组                                         │   │
│   │  - 按色相聚类，同色岩点归为一条线路                                    │   │
│   │  - 每条线路自动标记:                                                 │   │
│   │    - Top: Y 坐标最小的点 (画面最高)                                   │   │
│   │    - Start: Y 坐标最大的点 (画面最低)                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   输出: {                                                                   │
│     allHolds: [...],           // 所有岩点                                 │
│     routes: [                   // 线路分组                                │
│       { colorName: "gray", holds: [...], topHold, startHold },            │
│       { colorName: "yellow", holds: [...], topHold, startHold }           │
│     ]                                                                      │
│   }                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ 缓存结果，传给 Phase 2
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Phase 2: 实时分析 (逐帧执行)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   视频逐帧播放                                                               │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  MoveNet 姿态检测                                                    │   │
│   │  - 实时追踪人体 17 个关键点                                           │   │
│   │  - 重点: 手腕 (wrist)、脚踝 (ankle)                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  规则推理层                                                          │   │
│   │  1. 检测四肢触碰的岩点 (距离 < 阈值)                                  │   │
│   │  2. 自动确定当前线路 (首次触碰时)                                     │   │
│   │  3. 追踪攀爬进度 (已触碰岩点 / 线路总岩点)                            │   │
│   │  4. 检测高阶动作 (Heel Hook, Crossover)                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│   输出: {                                                                   │
│     activeRoute: "gray",        // 当前线路                                │
│     progress: 60,               // 攀爬进度 %                              │
│     currentActions: {           // 四肢位置                                │
│       leftHand: "G3",                                                      │
│       rightHand: "G2",                                                     │
│       ...                                                                  │
│     }                                                                      │
│   }                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 模型训练策略

### 4.1 标注策略

**只标注一类: `hold` (岩点)**

```yaml
# data.yaml
names:
  0: hold    # 就这一个类别
```

**不需要标注:**
- ❌ 不需要标 "这是 Top"
- ❌ 不需要标 "这是灰色线路"  
- ❌ 不需要标 "这是起步点"

### 4.2 训练数据建议

| 数据量 | 效果 |
|-------|------|
| 300 张 | 最小可用，效果一般 |
| 800-1500 张 | 推荐，效果不错 |
| 3000+ 张 | 理想，高精度 |

### 4.3 数据增强重点

```python
# 针对攀岩场景的增强
hsv_h=0.015,    # 色相抖动 (应对不同光照)
hsv_s=0.7,      # 饱和度抖动
hsv_v=0.4,      # 亮度抖动
degrees=10,     # 轻微旋转
scale=0.5,      # 缩放变化
fliplr=0.5,     # 左右翻转
```

---

## 5. 代码结构

```
src/logic/
├── hold_detector.ts        # Phase 1: 岩点检测
│   ├── sampleFrames()          # 关键帧抽取
│   ├── yoloDetect()            # YOLO 检测 (Mock)
│   ├── mergeDetections()       # 多帧融合
│   ├── extractColors()         # 颜色提取
│   ├── clusterByColor()        # 颜色聚类 → 线路
│   └── detectHolds()           # 完整 Pipeline
│
├── action_recognizer.ts    # Phase 2: 动作识别
│   ├── setHoldData()           # 加载岩点数据
│   ├── update(pose)            # 每帧更新
│   ├── detectAdvancedMoves()   # 高阶动作检测
│   └── getHint()               # 生成提示
│
├── pose_detector.ts        # MoveNet 姿态检测
├── beta_generator.ts       # Beta 文本生成
└── diff_analyzer.ts        # 序列对比分析
```

---

## 6. 关键算法

### 6.1 多帧融合 (NMS)

```typescript
function mergeDetections(allDetections, iouThreshold = 0.5) {
  // 1. 合并所有帧的检测结果
  // 2. 按置信度排序
  // 3. NMS 去重: IoU > 阈值的视为同一个岩点
  // 4. 保留置信度最高的
}
```

### 6.2 颜色聚类

```typescript
function clusterByColor(holds, hueThreshold = 25) {
  // 1. 计算每个岩点的主色调 (HSV)
  // 2. 按色相 (Hue) 聚类
  // 3. 色相差 < 25° 视为同一颜色
  // 4. 每组 = 一条线路
}
```

### 6.3 Top/Start 判定

```typescript
// 同一线路内:
// - Y 坐标最小 (画面最高) = Top
// - Y 坐标最大 (画面最低) = Start
route.holds.sort((a, b) => a.y - b.y);
route.topHold = route.holds[0];
route.startHold = route.holds[route.holds.length - 1];
```

---

## 7. 后续优化方向

- [ ] 深度学习岩点检测: 用 YOLO/SAM 替代颜色检测
- [ ] 3D 姿态重建: 引入 BlazePose 3D
- [ ] 用户反馈修正: 允许手动修正识别错误
- [ ] 多人场景支持
- [ ] 线路难度评估

---

## 8. 参考资源

- [YOLOv8 Documentation](https://docs.ultralytics.com/)
- [MoveNet Model](https://www.tensorflow.org/hub/tutorials/movenet)
- [ONNX Runtime Web](https://onnxruntime.ai/docs/get-started/with-javascript.html)

